/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.6.0
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Postmate=t()}(this,function(){"use strict";var p="application/x-postmate-v1+json",r=0,c=function(){var e;return h.debug?(e=console).log.apply(e,arguments):null},l={handshake:1,"handshake-reply":1,"handshake-timeout":1,call:1,emit:1,reply:1,request:1},m=function(e,t){return c(e.origin,t),!("object"==typeof t&&!t.includes(e.origin))&&(("string"!=typeof t||e.origin===t)&&(!!e.data&&(("object"!=typeof e.data||"postmate"in e.data)&&(e.data.type===p&&!!l[e.data.postmate]))))},u=function(){function t(e){var i=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},this.listener=function(e){if(!m(e,i.childOrigin))return!1;var t=((e||{}).data||{}).value||{},n=t.data,a=t.name;"emit"===e.data.postmate&&a in i.events&&i.events[a].forEach(function(e){e.call(i,n)})},t.initialized||(this.parent.addEventListener("message",this.listener,!1),t.initialized=!0)}var e=t.prototype;return e.get=function(e){var i=this;return new h.Promise(function(n){var a=++r;i.parent.addEventListener("message",function e(t){t.data.uid===a&&"reply"===t.data.postmate&&(i.parent.removeEventListener("message",e,!1),n(t.data.value))},!1),i.child.postMessage({postmate:"request",type:p,property:e,uid:a},i.childOrigin)})},e.call=function(e,t){this.child.postMessage({postmate:"call",type:p,property:e,data:t},this.childOrigin)},e.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},e.off=function(e,t){var n=-1;this.events[e]&&-1<(n=this.events[e].indexOf(t))&&this.events[e].splice(n,1)},e.deconnect=function(){window.removeEventListener("message",this.listener,!1)},e.destroy=function(){window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)},t}(),s=function(){function e(e){var d=this;this.model=e.model,this.parent=e.parent,this.parentOrigin=e.parentOrigin,this.child=e.child,this.child.addEventListener("message",function(t){if(m(t,d.parentOrigin)){var e,n,a,i=t.data,r=i.property,s=i.uid,o=i.data;if("call"!==t.data.postmate)(e=d.model,n=r,a="function"==typeof e[n]?e[n]():e[n],h.Promise.resolve(a)).then(function(e){return t.source.postMessage({property:r,postmate:"reply",type:p,uid:s,value:e},t.origin)});else r in d.model&&"function"==typeof d.model[r]&&d.model[r](o)}})}return e.prototype.emit=function(e,t){this.parent.postMessage({postmate:"emit",type:p,value:{name:e,data:t}},this.parentOrigin)},e}(),h=function(){function e(e){var t=e.container,n=void 0===t?void 0!==n?n:document.body:t,a=e.model,i=e.url,r=e.name,s=e.classListArray,o=void 0===s?[]:s;return this.parent=window,this.frame=document.createElement("iframe"),this.frame.name=r||"",this.frame.classList.add.apply(this.frame.classList,o),n.appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=a||{},this.sendHandshake(i)}return e.prototype.sendHandshake=function(a){var s=this;this.reconnect||(this.__childOrigin=function(e){var t=document.createElement("a");t.href=e;var n=4<t.protocol.length?t.protocol:window.location.protocol,a=t.host.length?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host;return t.origin||n+"//"+a}(a));var o,d=this.__childOrigin,h=0;return new e.Promise(function(i,r){var e=function e(t){if(c("Parent: sendHandshake() sanitize():",m(t,[d,s.parent.origin]),t,[d,s.parent.origin]),!m(t,[d,s.parent.origin]))return!1;var n="handshake-reply"===t.data.postmate,a="handshake-timeout"===t.data.postmate;return n||a?(window.clearInterval(o),s.reconnect=!0,s.parent.removeEventListener("message",e,!1),s.childOrigin=t.origin,i(new u(s))):l[t.data.postmate]?r("Failed handshake"):void 0},t=function(){if(h++,s.child.postMessage({postmate:"handshake",type:p,model:s.model},d),5===h)c("Parent: Reached max handshake attempts",h,5),s.parent.postMessage({postmate:"handshake-timeout",type:p},"*"),s.parent.postMessage({postmate:"emit",type:p,value:{name:"pageloadtimeout",data:{}}},"*");else if(5<=h){c("Parent: Killing handshake attempts:",h,o);var e=window.setInterval(function(){c("Parent: Handshake requests went out of control:",e)},1e4);c("Parent: Last intervalId",e);for(var t=0;t<=e;t++)window.clearInterval(t)}},n=function(){c("Parent: Iframe has loaded"),h=0,s.parent.addEventListener("message",e,!1),t(),o=window.setInterval(t,500)};s.reconnect||(s.frame.attachEvent?s.frame.attachEvent("onload",n):s.frame.addEventListener("load",n),s.frame.src=a)})},e}();return h.debug=!1,h.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),h.Model=function(){function e(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return e.prototype.sendHandshakeReply=function(){var r=this;return new h.Promise(function(a,i){r.child.addEventListener("message",function e(t){if(t.data.postmate){if("handshake"!==t.data.postmate)return i("Handshake Reply Failed");r.child.removeEventListener("message",e,!1),t.source.postMessage({postmate:"handshake-reply",type:p},t.origin),r.parentOrigin=t.origin;var n=t.data.model;return n&&Object.keys(n).forEach(function(e){r.model[e]=n[e]}),a(new s(r))}},!1)})},e}(),h});
